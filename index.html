<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Yoklama - Yaşar Üniversitesi</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const Icon = ({ name, ...props }) => {
      const IconComponent = lucide[name];
      return IconComponent ? React.createElement(IconComponent, props) : null;
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [type, setType] = useState(null);
      const [course, setCourse] = useState(null);
      const [qr, setQr] = useState('');
      const [code, setCode] = useState('');
      const [login, setLogin] = useState({ u: '', p: '' });
      const [week, setWeek] = useState(1);
      const [time, setTime] = useState(10);
      const [show, setShow] = useState(0);
      const [dark, setDark] = useState(false);
      const [notes, setNotes] = useState({});
      const [excuses, setExcuses] = useState({});

      const courses = [{ id: 1, code: 'ENGR 4400', name: 'Muhendislik Uyg. Uretken YZ' }];
      const teachers = [{ id: 1, u: 'ogretmen1', p: 'ogretmen123', name: 'Doc. Dr. Orkun Karabasoglu', c: [1] }];
      
      const allStudents = [
        'Ibrahim Gultekin,18070003013,Insaat', 'Elif Emine Gunal,19070001053,Bilgisayar', 'Erk Yanki Ural,19070008012,Makine',
        'Erce Ozkan,20070001057,Bilgisayar', 'Ipek Atis,20070002048,Endustri', 'Idil Ece Cevahir,20070007004,Enerji',
        'Sude Onfidan,20070008016,Makine', 'Omer Arica,20070008017,Makine', 'Selim Mert Kircaali,20070008019,Makine',
        'Beril Deran Gurbuz,20070008029,Makine', 'Ali Haktan Sigin,21070001004,Bilgisayar', 'Arda Altunhan,21070001051,Bilgisayar',
        'Ekrem Temel,21070001070,Bilgisayar', 'Nesrin Senturk,21070002005,Endustri', 'Batuhan Sisman,21070002025,Endustri',
        'Kivanc Efe Ergonul,21070005027,Elektrik', 'Oguz Koyucan,21070005030,Elektrik', 'Zeynep Arslanbuga,21070005042,Elektrik',
        'Beste Tekin,21070007001,Enerji', 'Ekin Altunkaya,21070007004,Enerji', 'Emre Erisir,21070008009,Makine',
        'Ismail Can Demirkan,21070008014,Makine', 'Can Girgin,21070008016,Makine', 'Kerem Eroglu,21070008017,Makine',
        'Armagan Soylu,21070008027,Makine', 'Alp Serkan Merkit,21070008033,Makine', 'Atakan Dincer,21070008034,Makine',
        'Demet Buyuktas,21070008206,Makine', 'Gurkan Eroglu,22070001041,Bilgisayar', 'Emre Efe Yuksel,22070001055,Bilgisayar',
        'Suleyman Batu Sari,22070002015,Endustri', 'Kadir Emre Gunes,22070002047,Endustri', 'Toprak Tuncer,22070005040,Elektrik',
        'Emre Can Hekimoglu,22070005053,Elektrik', 'Ilgar Senol,22070007014,Enerji', 'Eda Nur Caliskan,22070008017,Makine',
        'Sami Berk Sahin,22070008021,Makine', 'Deniz Unver,22070008026,Makine', 'Aykan Kanli,22070008034,Makine',
        'Deniz Karatepe,22070008043,Makine', 'Aysegul Karinyarici,22070003022,Insaat', 'Ahmet Ozgur Korkmaz,21070001046,Bilgisayar'
      ];

      const [stds, setStds] = useState(allStudents.map((s, i) => {
        const [name, no, dep] = s.split(',');
        return { id: i + 1, no, p: '123456', name, dep: dep + ' Muh.', c: [1], att: { 1: Array(14).fill(false) } };
      }));

      useEffect(() => {
        if (type === 'teacher' && course) {
          genQr();
          const i = setInterval(() => setTime(p => p <= 1 ? (genQr(), 10) : p - 1), 1000);
          return () => clearInterval(i);
        }
      }, [type, course]);

      const genQr = () => setQr(Math.random().toString(36).substring(2, 8).toUpperCase());
      const getStds = () => stds.filter(s => s.c.includes(course));
      const calc = (s) => {
        const a = s.att[course].filter(x => x).length;
        return { a, r: (a / 14 * 100).toFixed(1), w: a < 10, rem: 10 - a };
      };

      const doLogin = (t) => {
        if (t === 'teacher') {
          const x = teachers.find(y => y.u === login.u && y.p === login.p);
          x ? (setUser(x), setType('teacher'), setLogin({ u: '', p: '' })) : alert('Hata!');
        } else {
          const x = stds.find(y => y.no === login.u && y.p === login.p);
          x ? (setUser(x), setType('student'), setLogin({ u: '', p: '' })) : alert('Hata!');
        }
      };

      const submit = () => {
        if (code.toUpperCase() === qr) {
          setStds(stds.map(s => s.id === user.id ? { ...s, att: { ...s.att, [course]: s.att[course].map((x, i) => i === week - 1 ? true : x) } } : s));
          const updatedUser = stds.find(s => s.id === user.id);
          setUser({...updatedUser, att: { ...updatedUser.att, [course]: updatedUser.att[course].map((x, i) => i === week - 1 ? true : x) }});
          alert('Basariyla yoklama alindi!');
          setCode('');
        } else {
          alert('Hatali kod!');
          setCode('');
        }
      };

      const handleExcuse = (e) => {
        const file = e.target.files[0];
        if (file) {
          const key = user.id + '_' + course + '_' + week;
          const reader = new FileReader();
          reader.onload = () => {
            setExcuses({...excuses, [key]: { name: file.name, data: reader.result, status: 'pending', date: new Date().toLocaleDateString('tr-TR') }});
            alert('Mazeret belgesi yuklendi! Onay bekliyor.');
          };
          reader.readAsDataURL(file);
        }
      };

      const approveExc = (sid, wk) => {
        const key = sid + '_' + course + '_' + wk;
        setStds(stds.map(s => s.id === sid ? { ...s, att: { ...s.att, [course]: s.att[course].map((x, i) => i === wk - 1 ? true : x) } } : s));
        setExcuses({...excuses, [key]: {...excuses[key], status: 'approved'}});
        alert('Mazeret onaylandi!');
      };

      const rejectExc = (sid, wk) => {
        const key = sid + '_' + course + '_' + wk;
        setExcuses({...excuses, [key]: {...excuses[key], status: 'rejected'}});
        alert('Mazeret reddedildi!');
      };

      const getPendingExc = () => Object.entries(excuses).filter(([k, v]) => v.status === 'pending' && k.includes('_' + course + '_')).map(([k, v]) => {
        const [sid, cid, wk] = k.split('_');
        return { sid: parseInt(sid), wk: parseInt(wk), std: stds.find(x => x.id === parseInt(sid)), data: v };
      });

      const tog = (id) => setStds(stds.map(s => s.id === id ? { ...s, att: { ...s.att, [course]: s.att[course].map((x, i) => i === week - 1 ? !x : x) } } : s));
      
      const bulkMark = (v) => {
        setStds(stds.map(s => s.c.includes(course) ? { ...s, att: { ...s.att, [course]: s.att[course].map((x, i) => i === week - 1 ? v : x) } } : s));
        alert(v ? 'Tumu var!' : 'Tumu yok!');
      };

      const expAll = () => {
        let csv = 'ENGR 4400 TUM HAFTALAR\\n\\nOgrenci,No,';
        for (let i = 1; i <= 14; i++) csv += 'H' + i + ',';
        csv += 'Top,Oran\\n';
        getStds().forEach(s => {
          const st = calc(s);
          csv += s.name + ',' + s.no + ',';
          s.att[course].forEach(a => csv += (a ? 'V' : 'Y') + ',');
          csv += st.a + ',%' + st.r + '\\n';
        });
        const b = new Blob([csv], { type: 'text/csv' });
        const l = document.createElement('a');
        l.href = URL.createObjectURL(b);
        l.download = 'TumHaftalar.csv';
        l.click();
      };

      const predict = () => {
        const st = calc(user);
        if (st.rem <= 0) return 'Devam yukumlulugu tamam!';
        if (st.rem > (14 - week)) return 'Devam yukumlulugu saglanamaz!';
        return 'En az ' + st.rem + ' hafta daha gerekli!';
      };

      const bg = dark ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-orange-50';
      const card = dark ? 'bg-gray-800 text-white' : 'bg-white';

      if (!user) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 to-orange-600 flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-md border-4 border-orange-400">
              <div className="text-center mb-8">
                <img src="https://www.yasar.edu.tr/wp-content/themes/yasaruniversitesi/images/logo.png" alt="Logo" className="h-24 mx-auto mb-4" onError={(e) => e.target.style.display = 'none'} />
                <h1 className="text-4xl font-black text-blue-900">QR YOKLAMA</h1>
                <p className="text-orange-600 font-bold">Yasar Universitesi</p>
              </div>
              <input type="text" placeholder="Kullanici / Okul No" className="w-full px-5 py-4 bg-blue-50 border-2 rounded-2xl mb-4" value={login.u} onChange={(e) => setLogin({...login, u: e.target.value})} />
              <input type="password" placeholder="Sifre" className="w-full px-5 py-4 bg-blue-50 border-2 rounded-2xl mb-4" value={login.p} onChange={(e) => setLogin({...login, p: e.target.value})} />
              <div className="grid grid-cols-2 gap-4">
                <button onClick={() => doLogin('teacher')} className="bg-blue-800 text-white py-4 rounded-2xl font-bold">Ogretmen</button>
                <button onClick={() => doLogin('student')} className="bg-orange-500 text-white py-4 rounded-2xl font-bold">Ogrenci</button>
              </div>
              <div className="mt-6 p-4 bg-blue-50 rounded-xl text-sm">
                <p className="font-bold">Demo:</p>
                <p>Ogretmen: ogretmen1 / ogretmen123</p>
                <p>Ogrenci: 18070003013 / 123456</p>
              </div>
            </div>
          </div>
        );
      }

      if (!course) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 to-orange-600 flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-2xl border-4 border-orange-400">
              <div className="text-center mb-8">
                <Icon name="BookOpen" className="w-16 h-16 text-blue-900 mx-auto mb-4" />
                <h2 className="text-3xl font-black text-blue-900">Ders Secimi</h2>
                <p className="text-gray-600">{user.name}</p>
              </div>
              {courses.map(c => (
                <button key={c.id} onClick={() => setCourse(c.id)} className="w-full p-6 bg-gradient-to-r from-blue-50 to-orange-50 border-2 rounded-2xl hover:border-orange-500 mb-4">
                  <p className="text-xl font-black text-blue-900">{c.code}</p>
                  <p className="text-gray-700">{c.name}</p>
                </button>
              ))}
              <button onClick={() => setUser(null)} className="w-full bg-gray-200 py-3 rounded-2xl font-bold">Cikis</button>
            </div>
          </div>
        );
      }

      if (type === 'teacher') {
        const cs = getStds();
        const crit = cs.filter(s => calc(s).w).length;
        const pend = getPendingExc();

        return (
          <div className={bg + ' min-h-screen p-4'}>
            <div className="max-w-7xl mx-auto">
              <div className={card + ' rounded-2xl shadow-lg p-4 mb-4'}>
                <div className="flex justify-between items-center">
                  <div>
                    <h2 className="text-xl font-black">Ogretmen Paneli</h2>
                    <p className="text-xs opacity-80">{user.name}</p>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => setDark(!dark)} className="p-2 rounded-xl bg-gray-200">
                      <Icon name={dark ? "Sun" : "Moon"} size={16} />
                    </button>
                    {pend.length > 0 && (
                      <div className="relative">
                        <Icon name="Bell" size={20} className="text-red-600 animate-pulse" />
                        <span className="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">{pend.length}</span>
                      </div>
                    )}
                    <button onClick={() => {setUser(null); setCourse(null);}} className="bg-blue-900 text-white px-3 py-2 rounded-xl text-xs font-bold">Cikis</button>
                  </div>
                </div>
              </div>

              {crit > 0 && (
                <div className="bg-red-100 border-2 border-red-400 rounded-xl p-3 mb-4 flex gap-2">
                  <Icon name="AlertCircle" size={20} className="text-red-600" />
                  <p className="text-sm font-bold text-red-900">{crit} ogrenci kritik!</p>
                </div>
              )}

              {pend.length > 0 && (
                <div className="bg-yellow-100 border-2 border-yellow-400 rounded-xl p-4 mb-4">
                  <h3 className="font-bold text-yellow-900 mb-3">Onay Bekleyen Mazeret ({pend.length})</h3>
                  <div className="space-y-2">
                    {pend.map(e => (
                      <div key={e.sid + '_' + e.wk} className="bg-white p-3 rounded-xl flex justify-between items-center">
                        <div>
                          <p className="font-bold text-sm">{e.std.name}</p>
                          <p className="text-xs">Hafta {e.wk}</p>
                        </div>
                        <div className="flex gap-2">
                          <button onClick={() => approveExc(e.sid, e.wk)} className="bg-green-600 text-white p-2 rounded-lg">
                            <Icon name="Check" size={16} />
                          </button>
                          <button onClick={() => rejectExc(e.sid, e.wk)} className="bg-red-600 text-white p-2 rounded-lg">
                            <Icon name="X" size={16} />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <div className="grid lg:grid-cols-3 gap-4 mb-4">
                <div className="bg-gradient-to-br from-blue-800 to-orange-600 rounded-2xl p-6 text-white">
                  <div className="flex justify-between mb-3">
                    <h3 className="font-bold">QR Kod</h3>
                    <div className="bg-white bg-opacity-20 px-2 py-1 rounded text-xs">{time}s</div>
                  </div>
                  <div className="bg-white rounded-xl p-6 mb-3">
                    <div className="text-5xl font-mono font-black text-blue-900 text-center">{qr}</div>
                  </div>
                  <select value={week} onChange={(e) => setWeek(Number(e.target.value))} className="w-full px-3 py-2 rounded-xl bg-white bg-opacity-20 text-white font-bold text-sm">
                    {[...Array(14)].map((_, i) => <option key={i+1} value={i+1} className="bg-blue-800">Hafta {i+1}</option>)}
                  </select>
                </div>

                <div className="lg:col-span-2">
                  <div className={card + ' rounded-2xl shadow-lg p-4 mb-4'}>
                    <div className="flex justify-between mb-3">
                      <h3 className="font-bold text-sm">Islemler</h3>
                      <div className="flex gap-1">
                        <button onClick={() => bulkMark(true)} className="bg-green-600 text-white px-2 py-1 rounded text-xs">Tumu Var</button>
                        <button onClick={() => bulkMark(false)} className="bg-red-600 text-white px-2 py-1 rounded text-xs">Tumu Yok</button>
                        <button onClick={expAll} className="bg-green-600 text-white px-2 py-1 rounded text-xs">Excel</button>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-2">
                      <button onClick={() => setShow(show === 1 ? 0 : 1)} className={'p-3 rounded-xl font-bold text-xs ' + (show === 1 ? 'bg-blue-800 text-white' : 'bg-gray-100')}>Ogrenciler</button>
                      <button onClick={() => setShow(show === 2 ? 0 : 2)} className={'p-3 rounded-xl font-bold text-xs ' + (show === 2 ? 'bg-blue-800 text-white' : 'bg-gray-100')}>Cizelge</button>
                    </div>
                  </div>
                </div>
              </div>

              {show === 1 && (
                <div className={card + ' rounded-2xl shadow-lg p-4'}>
                  <div className="grid md:grid-cols-3 gap-2 max-h-96 overflow-y-auto">
                    {cs.map(s => {
                      const st = calc(s);
                      return (
                        <div key={s.id} className={'p-3 rounded-xl border ' + (st.w ? 'bg-red-50' : 'bg-green-50')}>
                          <div className="flex justify-between">
                            <div>
                              <p className="font-bold text-xs">{s.name}</p>
                              <p className="text-xs">%{st.r}</p>
                            </div>
                            <button onClick={() => tog(s.id)} className={'w-7 h-7 rounded ' + (s.att[course][week-1] ? 'bg-green-600' : 'bg-gray-300')}>
                              <Icon name={s.att[course][week-1] ? "CheckCircle" : "XCircle"} size={16} className="mx-auto text-white" />
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      const st = calc(user);
      const pred = predict();
      const excKey = user.id + '_' + course + '_' + week;
      const hasExc = excuses[excKey];

      return (
        <div className={bg + ' min-h-screen p-4'}>
          <div className="max-w-5xl mx-auto">
            <div className={card + ' rounded-2xl shadow-lg p-4 mb-4'}>
              <div className="flex justify-between">
                <div>
                  <h2 className="text-xl font-bold">Ogrenci Paneli</h2>
                  <p className="text-xs">{user.name}</p>
                </div>
                <button onClick={() => {setUser(null); setCourse(null);}} className="bg-blue-900 text-white px-3 py-2 rounded-xl text-xs font-bold">Cikis</button>
              </div>
            </div>

            <div className="grid md:grid-cols-2 gap-4 mb-4">
              <div className={card + ' rounded-2xl shadow-lg p-6'}>
                <h3 className="text-lg font-bold mb-4">Yoklama Kodu</h3>
                <input type="text" placeholder="6 haneli" className="w-full px-6 py-4 border-2 rounded-xl text-2xl text-center font-mono font-bold uppercase mb-4" value={code} onChange={(e) => setCode(e.target.value.toUpperCase())} maxLength={6} />
                <button onClick={submit} disabled={code.length !== 6} className="w-full bg-orange-500 text-white py-4 rounded-xl font-bold disabled:bg-gray-300 mb-3">Yoklama Ver</button>
                
                {!user.att[course][week-1] && (
                  <div className="border-t-2 pt-3">
                    <p className="text-sm font-bold mb-2">Mazeret Belgesi</p>
                    {hasExc ? (
                      <div className={'p-3 rounded-xl ' + (hasExc.status === 'pending' ? 'bg-yellow-100' : hasExc.status === 'approved' ? 'bg-green-100' : 'bg-red-100')}>
                        <p className="text-xs font-bold">{hasExc.name}</p>
                        <p className="text-xs">Durum: {hasExc.status === 'pending' ? 'Bekliyor' : hasExc.status === 'approved' ? 'Onaylandi' : 'Reddedildi'}</p>
                      </div>
                    ) : (
                      <input type="file" accept=".pdf,.jpg,.png" onChange={handleExcuse} className="w-full text-xs p-2 border rounded-xl" />
                    )}
                  </div>
                )}
              </div>

              <div className={'rounded-2xl shadow-lg p-6 text-white ' + (st.w ? 'bg-red-600' : 'bg-green-600')}>
                <h3 className="text-lg font-bold mb-4">Devam Durumu</h3>
                <div className="text-center">
                  <div className="text-6xl font-black mb-2">{st.a}</div>
                  <div className="text-xl mb-4">/ 14 hafta</div>
                  <div className="bg-white bg-opacity-20 rounded-xl p-4">
                    <div className="text-4xl font-black">%{st.r}</div>
                  </div>
                </div>
              </div>
            </div>

            <div className={card + ' rounded-2xl shadow-lg p-6'}>
              <p className="font-bold mb-2">Tahmin:</p>
              <p>{pred}</p>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>