<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yasar Universitesi Yoklama Sistemi</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Simple icon components
        const CheckCircle = () => <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"/></svg>;
        const XCircle = () => <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd"/></svg>;
        const BookOpen = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>;
        const Moon = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>;
        const Sun = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>;
        const Bell = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>;
        const AlertCircle = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>;
        const File = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>;
        const Check = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>;
        const X = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>;
        const FileText = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>;
        const Download = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>;
        const RefreshCw = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>;
        const BarChart3 = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>;
        const Target = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/></svg>;
        const Upload = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>;

        const App = () => {
          const [user, setUser] = useState(null);
          const [type, setType] = useState(null);
          const [course, setCourse] = useState(null);
          const [qr, setQr] = useState('');
          const [code, setCode] = useState('');
          const [login, setLogin] = useState({ u: '', p: '' });
          const [week, setWeek] = useState(1);
          const [time, setTime] = useState(10);
          const [show, setShow] = useState(0);
          const [dark, setDark] = useState(false);
          const [notes, setNotes] = useState({});
          const [excuses, setExcuses] = useState({});
          const [weekHistory, setWeekHistory] = useState({});

          const courses = [{ id: 1, code: 'ENGR 4400', name: 'Muhendislik Uyg. Uretken YZ' }];
          const teachers = [{ id: 1, u: 'ogretmen1', p: 'ogretmen123', name: 'Doc. Dr. Orkun Karabasoglu', c: [1] }];
          
          const allStudents = [
            'Ibrahim Gultekin,18070003013,Insaat', 'Elif Emine Gunal,19070001053,Bilgisayar', 'Erk Yanki Ural,19070008012,Makine',
            'Erce Ozkan,20070001057,Bilgisayar', 'Ipek Atis,20070002048,Endustri', 'Idil Ece Cevahir,20070007004,Enerji',
            'Sude Onfidan,20070008016,Makine', 'Omer Arica,20070008017,Makine', 'Selim Mert Kircaali,20070008019,Makine',
            'Beril Deran Gurbuz,20070008029,Makine', 'Ali Haktan Sigin,21070001004,Bilgisayar', 'Arda Altunhan,21070001051,Bilgisayar',
            'Ekrem Temel,21070001070,Bilgisayar', 'Nesrin Senturk,21070002005,Endustri', 'Batuhan Sisman,21070002025,Endustri',
            'Kivanc Efe Ergonul,21070005027,Elektrik', 'Oguz Koyucan,21070005030,Elektrik', 'Zeynep Arslanbuga,21070005042,Elektrik',
            'Beste Tekin,21070007001,Enerji', 'Ekin Altunkaya,21070007004,Enerji', 'Emre Erisir,21070008009,Makine',
            'Ismail Can Demirkan,21070008014,Makine', 'Can Girgin,21070008016,Makine', 'Kerem Eroglu,21070008017,Makine',
            'Armagan Soylu,21070008027,Makine', 'Alp Serkan Merkit,21070008033,Makine', 'Atakan Dincer,21070008034,Makine',
            'Demet Buyuktas,21070008206,Makine', 'Gurkan Eroglu,22070001041,Bilgisayar', 'Emre Efe Yuksel,22070001055,Bilgisayar',
            'Suleyman Batu Sari,22070002015,Endustri', 'Kadir Emre Gunes,22070002047,Endustri', 'Toprak Tuncer,22070005040,Elektrik',
            'Emre Can Hekimoglu,22070005053,Elektrik', 'Ilgar Senol,22070007014,Enerji', 'Eda Nur Caliskan,22070008017,Makine',
            'Sami Berk Sahin,22070008021,Makine', 'Deniz Unver,22070008026,Makine', 'Aykan Kanli,22070008034,Makine',
            'Deniz Karatepe,22070008043,Makine', 'Aysegul Karinyarici,22070003022,Insaat', 'Ahmet Ozgur Korkmaz,21070001046,Bilgisayar'
          ];

          const [stds, setStds] = useState(allStudents.map((s, i) => {
            const [name, no, dep] = s.split(',');
            return { id: i + 1, no, p: '123456', name, dep: dep + ' Muh.', c: [1], att: { 1: Array(14).fill(false) } };
          }));

          useEffect(() => {
            const saved = localStorage.getItem('attendanceData');
            if (saved) {
              const data = JSON.parse(saved);
              if (data.stds) setStds(data.stds);
              if (data.excuses) setExcuses(data.excuses);
              if (data.weekHistory) setWeekHistory(data.weekHistory);
            }
          }, []);

          useEffect(() => {
            const data = { stds, excuses, weekHistory };
            localStorage.setItem('attendanceData', JSON.stringify(data));
          }, [stds, excuses, weekHistory]);

          const weekCodes = {
            1: 'HAFTA1', 2: 'HAFTA2', 3: 'HAFTA3', 4: 'HAFTA4',
            5: 'HAFTA5', 6: 'HAFTA6', 7: 'HAFTA7', 8: 'HAFTA8',
            9: 'HAFTA9', 10: 'HFT10A', 11: 'HFT11A', 12: 'HFT12A',
            13: 'HFT13A', 14: 'HFT14A'
          };

          useEffect(() => {
            if (type === 'teacher' && course) {
              genQr();
              const i = setInterval(() => setTime(p => p <= 1 ? (genQr(), 10) : p - 1), 1000);
              return () => clearInterval(i);
            }
          }, [type, course, week]);

          const genQr = () => {
            const newQr = Math.random().toString(36).substring(2, 8).toUpperCase();
            setQr(newQr);
            // Kodu localStorage'a kaydet - 15 saniye geçerli
            const qrData = {
              code: newQr,
              week: week,
              time: Date.now()
            };
            localStorage.setItem('activeQR_' + course, JSON.stringify(qrData));
          };
          const getStds = () => stds.filter(s => s.c.includes(course));
          const calc = (s) => {
            const a = s.att[course].filter(x => x).length;
            return { a, r: (a / 14 * 100).toFixed(1), w: a < 10, rem: 10 - a };
          };

          const doLogin = (t) => {
            if (t === 'teacher') {
              const x = teachers.find(y => y.u === login.u && y.p === login.p);
              x ? (setUser(x), setType('teacher'), setLogin({ u: '', p: '' })) : alert('Hata!');
            } else {
              const x = stds.find(y => y.no === login.u && y.p === login.p);
              x ? (setUser(x), setType('student'), setLogin({ u: '', p: '' })) : alert('Hata!');
            }
          };

          const submit = () => {
            // Girilen kodu tüm hafta kodlarıyla karşılaştır
            let matchedWeek = null;
            
            for (let w = 1; w <= 14; w++) {
              if (code.toUpperCase() === weekCodes[w]) {
                matchedWeek = w;
                break;
              }
            }
            
            if (matchedWeek) {
              const newStds = stds.map(s => s.id === user.id ? { ...s, att: { ...s.att, [course]: s.att[course].map((x, i) => i === matchedWeek - 1 ? true : x) } } : s);
              setStds(newStds);
              setUser(newStds.find(s => s.id === user.id));
              
              const histKey = course + '_' + matchedWeek;
              const timestamp = new Date().toLocaleString('tr-TR');
              setWeekHistory({
                ...weekHistory,
                [histKey]: {
                  ...weekHistory[histKey],
                  [user.id]: { name: user.name, no: user.no, time: timestamp }
                }
              });
              
              alert('Basariyla yoklama alindi! (Hafta ' + matchedWeek + ')');
              setCode('');
              setWeek(matchedWeek);
            } else {
              alert('Hatali kod! Ogretmenin ekranindaki kodu dogru girdiginizden emin olun.');
              setCode('');
            }
          };

          const handleExcuse = (e) => {
            const file = e.target.files[0];
            if (file) {
              const key = user.id + '_' + course + '_' + week;
              const reader = new FileReader();
              reader.onload = () => {
                setExcuses({...excuses, [key]: { 
                  name: file.name, 
                  data: reader.result, 
                  type: file.type,
                  status: 'pending', 
                  date: new Date().toLocaleDateString('tr-TR') 
                }});
                alert('Mazeret belgesi yuklendi! Onay bekliyor.');
              };
              reader.readAsDataURL(file);
            }
          };

          const downloadExcuse = (key) => {
            const excuse = excuses[key];
            if (!excuse) return;
            
            const link = document.createElement('a');
            link.href = excuse.data;
            link.download = excuse.name;
            link.click();
          };

          const viewExcuse = (key) => {
            const excuse = excuses[key];
            if (!excuse) return;
            
            if (excuse.type.includes('pdf')) {
              window.open(excuse.data, '_blank');
            } else if (excuse.type.includes('image')) {
              const win = window.open('', '_blank');
              win.document.write('<html><head><title>' + excuse.name + '</title></head><body style="margin:0;display:flex;justify-content:center;align-items:center;background:#000;"><img src="' + excuse.data + '" style="max-width:100%;max-height:100vh;"></body></html>');
            } else {
              downloadExcuse(key);
            }
          };

          const approveExc = (sid, wk) => {
            const key = sid + '_' + course + '_' + wk;
            setStds(stds.map(s => s.id === sid ? { ...s, att: { ...s.att, [course]: s.att[course].map((x, i) => i === wk - 1 ? true : x) } } : s));
            setExcuses({...excuses, [key]: {...excuses[key], status: 'approved'}});
            alert('Mazeret onaylandi!');
          };

          const rejectExc = (sid, wk) => {
            const key = sid + '_' + course + '_' + wk;
            setExcuses({...excuses, [key]: {...excuses[key], status: 'rejected'}});
            alert('Mazeret reddedildi!');
          };

          const getPendingExc = () => Object.entries(excuses).filter(([k, v]) => v.status === 'pending' && k.includes('_' + course + '_')).map(([k, v]) => {
            const [sid, cid, wk] = k.split('_');
            return { sid: parseInt(sid), wk: parseInt(wk), std: stds.find(x => x.id === parseInt(sid)), data: v };
          });

          const tog = (id) => {
            const oldVal = stds.find(s => s.id === id)?.att[course][week-1];
            const newStds = stds.map(s => s.id === id ? { ...s, att: { ...s.att, [course]: s.att[course].map((x, i) => i === week - 1 ? !x : x) } } : s);
            setStds(newStds);
            
            const histKey = course + '_' + week;
            const timestamp = new Date().toLocaleString('tr-TR');
            const student = newStds.find(s => s.id === id);
            
            if (!oldVal && newStds.find(s => s.id === id).att[course][week-1]) {
              setWeekHistory({
                ...weekHistory,
                [histKey]: {
                  ...weekHistory[histKey],
                  [id]: { name: student.name, no: student.no, time: timestamp, manual: true }
                }
              });
            }
          };
          
          const bulkMark = (v) => {
            setStds(stds.map(s => s.c.includes(course) ? { ...s, att: { ...s.att, [course]: s.att[course].map((x, i) => i === week - 1 ? v : x) } } : s));
            alert(v ? 'Tumu var!' : 'Tumu yok!');
          };

          const resetAll = () => {
            if (window.confirm('TUM YOKLAMA VERILERI SILINECEK! Emin misiniz?')) {
              if (window.confirm('Bu islem geri alinamaz! Son kez onayliyor musunuz?')) {
                const resetStds = allStudents.map((s, i) => {
                  const [name, no, dep] = s.split(',');
                  return { id: i + 1, no, p: '123456', name, dep: dep + ' Muh.', c: [1], att: { 1: Array(14).fill(false) } };
                });
                
                setStds(resetStds);
                setWeekHistory({});
                setExcuses({});
                setNotes({});
                
                localStorage.removeItem('attendanceData');
                
                alert('Tum veriler sifirlandi! Sayfa yenilenecek.');
                window.location.reload();
              }
            }
          };

          const expAll = () => {
            let csv = 'ENGR 4400 - YOKLAMA RAPORU\n';
            csv += 'Rapor Tarihi: ' + new Date().toLocaleString('tr-TR') + '\n\n';
            
            csv += 'GENEL OZET\n';
            csv += 'Toplam Ogrenci,' + getStds().length + '\n';
            csv += 'Toplam Hafta,14\n';
            csv += 'Devam Yuzde Esigi,%70\n\n';
            
            csv += 'TUM HAFTALAR YOKLAMA TABLOSU\n';
            csv += 'Ogrenci,No,Bolum,';
            for (let i = 1; i <= 14; i++) csv += 'Hafta ' + i + ',';
            csv += 'Toplam Katilim,Devam Yuzdesi,Durum\n';
            
            getStds().forEach(s => {
              const st = calc(s);
              csv += '"' + s.name + '",' + s.no + ',"' + s.dep + '",';
              s.att[course].forEach(a => csv += (a ? 'VAR' : 'YOK') + ',');
              csv += st.a + ',' + st.r + '%,' + (st.w ? 'KRITIK' : 'BASARILI') + '\n';
            });
            
            csv += '\n\nHAFTALIK DETAYLI KAYITLAR\n\n';
            
            for (let wk = 1; wk <= 14; wk++) {
              const histKey = course + '_' + wk;
              const weekData = weekHistory[histKey];
              
              csv += 'HAFTA ' + wk + '\n';
              csv += 'Ogrenci,No,Yoklama Zamani,Yontem\n';
              
              if (weekData && Object.keys(weekData).length > 0) {
                Object.entries(weekData).forEach(([sid, data]) => {
                  csv += '"' + data.name + '",' + data.no + ',"' + data.time + '",' + (data.manual ? 'Manuel' : 'QR Kod') + '\n';
                });
              } else {
                csv += 'Bu hafta icin kayit bulunamadi\n';
              }
              csv += '\n';
            }
            
            csv += '\nMAZERET BELGESI DURUMU\n';
            csv += 'Ogrenci,No,Hafta,Dosya,Tarih,Durum\n';
            Object.entries(excuses).forEach(([key, exc]) => {
              if (key.includes('_' + course + '_')) {
                const [sid, cid, wk] = key.split('_');
                const student = stds.find(s => s.id === parseInt(sid));
                if (student) {
                  const statusTR = exc.status === 'pending' ? 'BEKLIYOR' : exc.status === 'approved' ? 'ONAYLANDI' : 'REDDEDILDI';
                  csv += '"' + student.name + '",' + student.no + ',' + wk + ',"' + exc.name + '",' + exc.date + ',' + statusTR + '\n';
                }
              }
            });
            
            const b = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const l = document.createElement('a');
            l.href = URL.createObjectURL(b);
            l.download = 'ENGR4400_Yoklama_Raporu_' + new Date().toLocaleDateString('tr-TR').replace(/\./g, '_') + '.csv';
            l.click();
          };

          const predict = () => {
            const st = calc(user);
            if (st.rem <= 0) return 'Devam yukumlulugu tamam!';
            if (st.rem > (14 - week)) return 'Devam yukumlulugu saglanamaz!';
            return 'En az ' + st.rem + ' hafta daha gerekli!';
          };

          const bg = dark ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-orange-50';
          const card = dark ? 'bg-gray-800 text-white' : 'bg-white';

          if (!user) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-900 to-orange-600 flex items-center justify-center p-4">
                <div className="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-md border-4 border-orange-400">
                  <div className="text-center mb-8">
                    <img src="https://www.yasar.edu.tr/wp-content/themes/yasaruniversitesi/images/logo.png" alt="Logo" className="h-24 mx-auto mb-4" onError={(e) => e.target.style.display = 'none'} />
                    <h1 className="text-4xl font-black text-blue-900">KOD SİSTEMİ</h1>
                    <p className="text-orange-600 font-bold">Yasar Universitesi Yoklama Sistemi</p>
                  </div>
                  <input type="text" placeholder="Kullanici / Okul No" className="w-full px-5 py-4 bg-blue-50 border-2 rounded-2xl mb-4" value={login.u} onChange={(e) => setLogin({...login, u: e.target.value})} />
                  <input type="password" placeholder="Sifre" className="w-full px-5 py-4 bg-blue-50 border-2 rounded-2xl mb-4" value={login.p} onChange={(e) => setLogin({...login, p: e.target.value})} />
                  <div className="grid grid-cols-2 gap-4">
                    <button onClick={() => doLogin('teacher')} className="bg-blue-800 text-white py-4 rounded-2xl font-bold">Ogretmen</button>
                    <button onClick={() => doLogin('student')} className="bg-orange-500 text-white py-4 rounded-2xl font-bold">Ogrenci</button>
                  </div>
                  <div className="mt-6 p-4 bg-blue-50 rounded-xl text-sm">
                    <p className="font-bold">Demo:</p>
                    <p>Ogr: ogretmen1/ogretmen123</p>
                    <p>Std: 18070003013/123456</p>
                  </div>
                </div>
              </div>
            );
          }

          if (!course) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-900 to-orange-600 flex items-center justify-center p-4">
                <div className="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-2xl border-4 border-orange-400">
                  <div className="text-center mb-8">
                    <BookOpen className="w-16 h-16 text-blue-900 mx-auto mb-4" />
                    <h2 className="text-3xl font-black text-blue-900">Ders Secimi</h2>
                    <p className="text-gray-600">{user.name}</p>
                  </div>
                  {courses.map(c => (
                    <button key={c.id} onClick={() => setCourse(c.id)} className="w-full p-6 bg-gradient-to-r from-blue-50 to-orange-50 border-2 rounded-2xl hover:border-orange-500 mb-4">
                      <p className="text-xl font-black text-blue-900">{c.code}</p>
                      <p className="text-gray-700">{c.name}</p>
                    </button>
                  ))}
                  <button onClick={() => setUser(null)} className="w-full bg-gray-200 py-3 rounded-2xl font-bold">Cikis</button>
                </div>
              </div>
            );
          }

          if (type === 'teacher') {
            const cs = getStds();
            const crit = cs.filter(s => calc(s).w).length;
            const pend = getPendingExc();

            return (
              <div className={bg + ' min-h-screen p-4'}>
                <div className="max-w-7xl mx-auto">
                  <div className={card + ' rounded-2xl shadow-lg p-4 mb-4'}>
                    <div className="flex justify-between items-center flex-wrap gap-2">
                      <div>
                        <h2 className="text-xl font-black">Ogretmen Paneli</h2>
                        <p className="text-xs opacity-80">{user.name}</p>
                        <p className="text-orange-600 font-bold text-xs">ENGR 4400</p>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => setDark(!dark)} className="p-2 rounded-xl bg-gray-200">
                          {dark ? <Sun className="w-4 h-4" /> : <Moon className="w-4 h-4" />}
                        </button>
                        {pend.length > 0 && (
                          <div className="relative">
                            <Bell className="w-5 h-5 text-red-600 animate-pulse" />
                            <span className="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">{pend.length}</span>
                          </div>
                        )}
                        <button onClick={() => setCourse(null)} className="bg-orange-500 text-white px-3 py-2 rounded-xl text-xs font-bold">Ders</button>
                        <button onClick={() => {setUser(null); setCourse(null);}} className="bg-blue-900 text-white px-3 py-2 rounded-xl text-xs font-bold">Cikis</button>
                      </div>
                    </div>
                  </div>

                  {crit > 0 && (
                    <div className="bg-red-100 border-2 border-red-400 rounded-xl p-3 mb-4 flex gap-2">
                      <AlertCircle className="w-5 h-5 text-red-600" />
                      <p className="text-sm font-bold text-red-900">{crit} ogrenci kritik!</p>
                    </div>
                  )}

                  {pend.length > 0 && (
                    <div className="bg-yellow-100 border-2 border-yellow-400 rounded-xl p-4 mb-4">
                      <h3 className="font-bold text-yellow-900 mb-3 flex items-center gap-2">
                        <File className="w-5 h-5" />
                        Onay Bekleyen Mazeret ({pend.length})
                      </h3>
                      <div className="space-y-2">
                        {pend.map(e => (
                          <div key={e.sid + '_' + e.wk} className="bg-white p-3 rounded-xl">
                            <div className="flex justify-between items-start mb-2">
                              <div className="flex-1">
                                <p className="font-bold text-sm">{e.std.name}</p>
                                <p className="text-xs text-gray-600">{e.std.no} - {e.std.dep}</p>
                                <p className="text-xs text-gray-600">Hafta {e.wk} - {e.data.date}</p>
                              </div>
                              <div className="flex gap-2">
                                <button onClick={() => approveExc(e.sid, e.wk)} className="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700" title="Onayla">
                                  <Check className="w-4 h-4" />
                                </button>
                                <button onClick={() => rejectExc(e.sid, e.wk)} className="bg-red-600 text-white p-2 rounded-lg hover:bg-red-700" title="Reddet">
                                  <X className="w-4 h-4" />
                                </button>
                              </div>
                            </div>
                            <div className="flex gap-2 mt-2">
                              <button 
                                onClick={() => viewExcuse(e.sid + '_' + course + '_' + e.wk)} 
                                className="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 flex items-center justify-center gap-1"
                              >
                                <FileText className="w-4 h-4" />
                                Görüntüle
                              </button>
                              <button 
                                onClick={() => downloadExcuse(e.sid + '_' + course + '_' + e.wk)} 
                                className="flex-1 bg-orange-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-orange-700 flex items-center justify-center gap-1"
                              >
                                <Download className="w-4 h-4" />
                                İndir
                              </button>
                            </div>
                            <div className="mt-2 bg-gray-100 p-2 rounded text-xs">
                              <p className="text-gray-700 truncate" title={e.data.name}>📎 {e.data.name}</p>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  <div className="grid lg:grid-cols-3 gap-4 mb-4">
                    <div className="bg-gradient-to-br from-blue-800 to-orange-600 rounded-2xl p-6 text-white">
                      <div className="flex justify-between mb-3">
                        <h3 className="font-bold">QR Kod</h3>
                        <div className="bg-white bg-opacity-20 px-2 py-1 rounded text-xs">
                          Hafta {week}
                        </div>
                      </div>
                      <div className="bg-white rounded-xl p-6 mb-3">
                        <div className="text-5xl font-mono font-black text-blue-900 text-center">{qr}</div>
                      </div>
                      <select value={week} onChange={(e) => setWeek(Number(e.target.value))} className="w-full px-3 py-2 rounded-xl bg-white bg-opacity-20 text-white font-bold text-sm mb-2">
                        {[...Array(14)].map((_, i) => <option key={i+1} value={i+1} className="bg-blue-800">Hafta {i+1}</option>)}
                      </select>
                      <div className="bg-white bg-opacity-10 rounded-xl p-2 text-sm">
                        <div className="flex justify-between">
                          <span>Toplam:</span>
                          <span className="font-bold">{cs.length}</span>
                        </div>
                        <div className="flex justify-between">
                          <span>Katilan:</span>
                          <span className="font-bold">{cs.filter(s => s.att[course][week-1]).length}</span>
                        </div>
                      </div>
                    </div>

                    <div className="lg:col-span-2 space-y-4">
                      <div className={card + ' rounded-2xl shadow-lg p-4'}>
                        <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                          <BarChart3 className="w-4 h-4 text-orange-600" />
                          Haftalik Grafik
                        </h3>
                        <div className="grid grid-cols-7 gap-1">
                          {[...Array(14)].map((_, i) => {
                            const att = cs.filter(s => s.att[course][i]).length;
                            const pct = (att / cs.length) * 100;
                            return (
                              <div key={i} className="text-center">
                                <div className="h-16 bg-gray-200 rounded relative overflow-hidden">
                                  <div className="absolute bottom-0 w-full bg-gradient-to-t from-blue-600 to-orange-500" style={{height: pct + '%'}}></div>
                                </div>
                                <p className="text-xs mt-1">H{i+1}</p>
                              </div>
                            );
                          })}
                        </div>
                      </div>

                      <div className={card + ' rounded-2xl shadow-lg p-4'}>
                        <div className="flex justify-between mb-3 flex-wrap gap-2">
                          <h3 className="font-bold text-sm">Islemler</h3>
                          <div className="flex gap-1 flex-wrap">
                            <button onClick={() => bulkMark(true)} className="bg-green-600 text-white px-2 py-1 rounded text-xs">Tumu Var</button>
                            <button onClick={() => bulkMark(false)} className="bg-red-600 text-white px-2 py-1 rounded text-xs">Tumu Yok</button>
                            <button onClick={expAll} className="bg-green-600 text-white px-2 py-1 rounded text-xs flex items-center gap-1">
                              <Download className="w-3 h-3" />Excel
                            </button>
                            <button onClick={resetAll} className="bg-red-700 text-white px-2 py-1 rounded text-xs font-bold flex items-center gap-1">
                              <XCircle className="w-3 h-3" />Sıfırla
                            </button>
                          </div>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                          <button onClick={() => setShow(show === 1 ? 0 : 1)} className={'p-3 rounded-xl font-bold text-xs ' + (show === 1 ? 'bg-blue-800 text-white' : 'bg-gray-100')}>Ogrenciler ({cs.length})</button>
                          <button onClick={() => setShow(show === 2 ? 0 : 2)} className={'p-3 rounded-xl font-bold text-xs ' + (show === 2 ? 'bg-blue-800 text-white' : 'bg-gray-100')}>Cizelge</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  {show === 1 && (
                    <div className={card + ' rounded-2xl shadow-lg p-4'}>
                      <h3 className="font-bold mb-3 text-sm">Ogrenciler</h3>
                      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-96 overflow-y-auto">
                        {cs.map(s => {
                          const st = calc(s);
                          return (
                            <div key={s.id} className={'p-3 rounded-xl border ' + (st.w ? 'bg-red-50 border-red-300' : 'bg-green-50 border-green-300')}>
                              <div className="flex justify-between mb-2">
                                <div className="flex-1 min-w-0">
                                  <p className="font-bold text-xs truncate">{s.name}</p>
                                  <p className="text-xs text-gray-600">{s.dep}</p>
                                </div>
                                <button onClick={() => tog(s.id)} className={'w-7 h-7 rounded flex-shrink-0 ' + (s.att[course][week-1] ? 'bg-green-600' : 'bg-gray-300')}>
                                  {s.att[course][week-1] ? <CheckCircle /> : <XCircle />}
                                </button>
                              </div>
                              <p className="text-xs">%{st.r} ({st.a}/14)</p>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}

                  {show === 2 && (
                    <div className={card + ' rounded-2xl shadow-lg p-4 overflow-x-auto'}>
                      <table className="w-full text-xs">
                        <thead>
                          <tr className="border-b-2">
                            <th className="p-1 text-left sticky left-0 bg-white">Ogrenci</th>
                            {[...Array(14)].map((_, i) => <th key={i} className="p-1">H{i+1}</th>)}
                            <th className="p-1">%</th>
                          </tr>
                        </thead>
                        <tbody>
                          {cs.map(s => {
                            const st = calc(s);
                            return (
                              <tr key={s.id} className="border-b">
                                <td className="p-1 font-semibold text-xs sticky left-0 bg-white">{s.name}</td>
                                {s.att[course].map((a, i) => <td key={i} className="p-1 text-center">{a ? '✓' : '✗'}</td>)}
                                <td className={'p-1 text-center font-bold ' + (st.w ? 'text-red-600' : 'text-green-600')}>{st.r}</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}

                  <div className={card + ' rounded-2xl shadow-lg p-4 mt-4'}>
                    <h3 className="font-bold mb-3 text-sm flex items-center gap-2">
                      <FileText className="w-4 h-4 text-blue-600" />
                      Hafta {week} Detayli Kayitlar
                    </h3>
                    <div className="max-h-64 overflow-y-auto">
                      {weekHistory[course + '_' + week] ? (
                        <div className="space-y-2">
                          {Object.entries(weekHistory[course + '_' + week]).map(([sid, data]) => (
                            <div key={sid} className="bg-gray-50 p-3 rounded-xl flex justify-between items-center">
                              <div>
                                <p className="font-bold text-sm">{data.name}</p>
                                <p className="text-xs text-gray-600">{data.no}</p>
                              </div>
                              <div className="text-right">
                                <p className="text-xs text-gray-600">{data.time}</p>
                                {data.manual && <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Manuel</span>}
                              </div>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <p className="text-center text-gray-400 text-sm py-8">Bu hafta icin henuz kayit yok</p>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          const st = calc(user);
          const pred = predict();
          const excKey = user.id + '_' + course + '_' + week;
          const hasExc = excuses[excKey];

          return (
            <div className={bg + ' min-h-screen p-4'}>
              <div className="max-w-5xl mx-auto">
                <div className={card + ' rounded-2xl shadow-lg p-4 mb-4'}>
                  <div className="flex justify-between items-center">
                    <div>
                      <h2 className="text-xl font-bold">Ogrenci Paneli</h2>
                      <p className="text-xs opacity-80">{user.name} - {user.no}</p>
                      <p className="text-orange-600 font-bold text-xs">ENGR 4400</p>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => setDark(!dark)} className="p-2 rounded-xl bg-gray-200">
                        {dark ? <Sun className="w-4 h-4" /> : <Moon className="w-4 h-4" />}
                      </button>
                      <button onClick={() => setCourse(null)} className="bg-orange-500 text-white px-3 py-2 rounded-xl text-xs font-bold">Ders</button>
                      <button onClick={() => {setUser(null); setCourse(null);}} className="bg-blue-900 text-white px-3 py-2 rounded-xl text-xs font-bold">Cikis</button>
                    </div>
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-4 mb-4">
                  <div className={card + ' rounded-2xl shadow-lg p-6'}>
                    <h3 className="text-lg font-bold mb-4">Yoklama Kodu</h3>
                    <div className="mb-4">
                      <label className="text-sm font-bold mb-2 block">Hafta Seç:</label>
                      <select value={week} onChange={(e) => setWeek(Number(e.target.value))} className="w-full px-4 py-3 border-2 rounded-xl font-bold text-lg bg-white">
                        {[...Array(14)].map((_, i) => <option key={i+1} value={i+1}>Hafta {i+1}</option>)}
                      </select>
                    </div>
                    <input type="text" placeholder="6 haneli kod" className="w-full px-6 py-4 border-2 rounded-xl text-2xl text-center font-mono font-bold uppercase mb-4" value={code} onChange={(e) => setCode(e.target.value.toUpperCase())} maxLength={6} />
                    <button onClick={submit} disabled={code.length !== 6} className="w-full bg-orange-500 text-white py-4 rounded-xl font-bold disabled:bg-gray-300 mb-3">Yoklama Ver</button>
                    <p className="text-xs text-center text-gray-600">Öğretmenin ekrandaki kodu girin</p>
                    
                    {!user.att[course][week-1] && (
                      <div className="border-t-2 pt-3 mt-3">
                        <p className="text-sm font-bold mb-2 flex items-center gap-2">
                          <Upload className="w-4 h-4" />
                          Mazeret Belgesi Yukle
                        </p>
                        {hasExc ? (
                          <div className={'p-3 rounded-xl ' + (hasExc.status === 'pending' ? 'bg-yellow-100' : hasExc.status === 'approved' ? 'bg-green-100' : 'bg-red-100')}>
                            <p className="text-xs font-bold">{hasExc.name}</p>
                            <p className="text-xs">Durum: {hasExc.status === 'pending' ? 'Bekliyor' : hasExc.status === 'approved' ? 'Onaylandi' : 'Reddedildi'}</p>
                          </div>
                        ) : (
                          <input type="file" accept=".pdf,.jpg,.png" onChange={handleExcuse} className="w-full text-xs p-2 border rounded-xl" />
                        )}
                      </div>
                    )}
                  </div>

                  <div className={'rounded-2xl shadow-lg p-6 text-white ' + (st.w ? 'bg-red-600' : 'bg-green-600')}>
                    <h3 className="text-lg font-bold mb-4">Devam Durumu</h3>
                    <div className="text-center">
                      <div className="text-6xl font-black mb-2">{st.a}</div>
                      <div className="text-xl mb-4">/ 14 hafta</div>
                      <div className="bg-white bg-opacity-20 rounded-xl p-4 mb-3">
                        <div className="text-4xl font-black">%{st.r}</div>
                      </div>
                      {st.w && (
                        <div className="bg-white bg-opacity-20 p-3 rounded-xl">
                          <p className="font-bold">UYARI!</p>
                          <p className="text-sm">Devam yukumlulugu saglanamadi</p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                <div className={card + ' rounded-2xl shadow-lg p-6 mb-4'}>
                  <div className="flex items-center gap-3 mb-4">
                    <Target className="w-6 h-6 text-blue-600" />
                    <div>
                      <h3 className="font-bold">Tahmin</h3>
                      <p className="text-sm">{pred}</p>
                    </div>
                  </div>
                </div>

                <div className={card + ' rounded-2xl shadow-lg p-6'}>
                  <h3 className="text-lg font-bold mb-4">Haftalik Durum</h3>
                  <div className="grid grid-cols-7 gap-2">
                    {user.att[course].map((a, i) => (
                      <div key={i} className={'p-3 rounded-xl text-center font-bold ' + (a ? 'bg-green-500 text-white' : 'bg-gray-200')}>
                        <div className="text-xs">H{i+1}</div>
                        <div className="text-lg">{a ? '✓' : '✗'}</div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className={card + ' rounded-2xl shadow-lg p-6 mt-4'}>
                  <h3 className="font-bold mb-3 flex items-center gap-2">
                    <FileText className="w-5 h-5 text-blue-600" />
                    Gecmis Yoklama Kayitlarim
                  </h3>
                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {user.att[course].map((attended, wk) => {
                      const histKey = course + '_' + (wk + 1);
                      const myRecord = weekHistory[histKey]?.[user.id];
                      
                      if (!attended) return null;
                      
                      return (
                        <div key={wk} className="bg-green-50 border border-green-200 p-3 rounded-xl">
                          <div className="flex justify-between items-center">
                            <div>
                              <p className="font-bold text-sm">Hafta {wk + 1}</p>
                              {myRecord && (
                                <>
                                  <p className="text-xs text-gray-600">{myRecord.time}</p>
                                  {myRecord.manual && <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded mt-1 inline-block">Ogretmen tarafindan eklendi</span>}
                                </>
                              )}
                            </div>
                            <span className="text-2xl">✓</span>
                          </div>
                        </div>
                      );
                    }).filter(Boolean)}
                    {user.att[course].filter(x => x).length === 0 && (
                      <p className="text-center text-gray-400 py-8">Henuz yoklama kaydınız yok</p>
                    )}
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>